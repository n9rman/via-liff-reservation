<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約表單</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            liff.init({ liffId: "YOUR_LIFF_ID" })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        liff.getProfile().then(profile => {
                            document.getElementById("userId").value = profile.userId;
                        });
                    }
                })
                .catch(err => console.error(err));
        });

        function validateForm() {
            const dateInput = document.getElementById("date").value;
            const timeInput = document.getElementById("time").value;
            const today = new Date().toISOString().split('T')[0];
            
            if (dateInput < today) {
                alert("請選擇有效的日期！");
                return false;
            }
            return true;
        }

        async function submitForm(event) {
            event.preventDefault();
            if (!validateForm()) return;
            
            const data = {
                userId: document.getElementById("userId").value,
                name: document.getElementById("name").value,
                phone: document.getElementById("phone").value,
                date: document.getElementById("date").value,
                time: document.getElementById("time").value
            };
            
            fetch("https://YOUR_API_URL/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                if (result.status === "success") {
                    sendFlexMessage(data);
                }
            })
            .catch(error => console.error("Error:", error));
        }

        function sendFlexMessage(data) {
            const flexMessage = {
                "type": "flex",
                "altText": "預約成功通知",
                "contents": {
                    "type": "bubble",
                    "size": "kilo",
                    "header": {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            { "type": "text", "text": "預約確認", "weight": "bold", "size": "xl", "color": "#ffffff" }
                        ],
                        "backgroundColor": "#333333"
                    },
                    "body": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": [
                            { "type": "text", "text": `姓名：${data.name}`, "size": "md", "wrap": true },
                            { "type": "text", "text": `電話：${data.phone}`, "size": "md", "wrap": true },
                            { "type": "text", "text": `預約日期：${data.date}`, "size": "md", "wrap": true },
                            { "type": "text", "text": `預約時間：${data.time}`, "size": "md", "wrap": true }
                        ]
                    }
                }
            };
            
            liff.sendMessages([flexMessage])
                .then(() => liff.closeWindow())
                .catch(error => console.error("Error sending Flex Message:", error));
        }
    </script>
</head>
<body>
    <form onsubmit="submitForm(event)">
        <input type="hidden" id="userId">
        <label>姓名: <input type="text" id="name" required></label><br>
        <label>電話: <input type="tel" id="phone" required></label><br>
        <label>日期: <input type="date" id="date" required></label><br>
        <label>時間: <input type="time" id="time" required></label><br>
        <button type="submit">提交預約</button>
    </form>
</body>
</html>
